<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<title>TV - Jaka To Melodia</title>
		<script src="/socket.js"></script>
		<script src="/wakelock.js"></script>

		<link rel="stylesheet" href="/pattern.css" />
		<link rel="stylesheet" href="/loader.css" />

		<style>
			body {
				height: 100vh;
				padding: 0;
				margin: 0;
				display: flex;
				align-items: center;
				justify-content: center;
				flex-direction: column;
				--pattern: 22px;
			}

			.status {
				font-size: 150px;
			}

			.queue {
				font-size: 30px;
				font-family: monospace;
				text-align: left;
				width: 80vw;
				counter-reset: poz;
			}

			.queue > .nick {
				padding: 0.1em 0.25em 0.2em;
				color: #666;
			}

			.queue > .nick::before {
				counter-increment: poz;
				content: '#' counter(poz) ' ';
				font-weight: bold;
				color: #ccc;
			}

			.queue > img {
				height: 10vh;
			}

			.nick.active {
				background-color: #fff6;
				color: #333;
			}

			#loader {
				margin: auto;
				display: block;
			}
		</style>
	</head>
	<body class="patterned">
		<div id="status" class="status">⏯</div>

		<span id="spinner" class="loader"></span>

		<div id="queue" class="queue"></div>

		<script>
			requestWakeLock()

			const statuses = {
					paused: '⏸',
					playing: '⏵',
					waiting: '⏯',
				},
				colors = {
					playing: '#00ff58',
					paused: '#1b2660',
					waiting: '#2f3d40',
				}

			let nodeStatus = document.querySelector('#status'),
				nodeSpinner = document.querySelector('#spinner'),
				nodeQueue = document.querySelector('#queue')

			function setStatus(status = 'waiting') {
				const patternColors = {
					playing: { fg: '#18dd5c', bg: '#1bc957' },
					paused: { fg: '#28357d', bg: '#22307b' },
					waiting: { fg: '#364d69', bg: '#425b79' },
				}

				console.info('status', status)

				nodeStatus.innerHTML = statuses[status]
				document.body.style.setProperty('--fgcolor', patternColors[status].fg)
				document.body.style.setProperty('--bgcolor', patternColors[status].bg)
			}

			function setQueue(queue, active = 0) {
				nodeQueue.innerHTML = queue
					.map(
						(nick, i) =>
							`<div class="nick ${i == active && 'active'}">${nick}</div>`
					)
					.join('')
			}

			function showSpinner(show = true) {
				nodeSpinner.style.display = show ? 'block' : 'none'
			}

			const socket = new Socket('tv')

			var localStatus = 'waiting',
				localQueue = [],
				localActive = 0

			setStatus()

			socket.bind((data) => {
				if (data.status != localStatus) {
					localStatus = data.status
					setStatus(data.status)
				}

				if (data.active == null) {
					setQueue([])
					showSpinner()
				}

				if (data.queue.length > 0) {
					setQueue(data.queue, data.active)
					showSpinner(false)
				}

				// nodeStatus.innerHTML = statuses[data.status ?? 'waiting']
				// document.body.style.background = colors[data.status ?? 'waiting']
				// document.body.style.setProperty(
				// 	'--fgcolor',
				// 	patternColors[data.status ?? 'waiting'].fg
				// )
				// document.body.style.setProperty(
				// 	'--bgcolor',
				// 	patternColors[data.status ?? 'waiting'].bg
				// )
			})

			// ws.onopen = () => {
			// 	// clear()
			// 	// send.tv()

			// 	ws.onmessage = (data) => {
			// 		// let stats = JSON.parse(data.data)
			// 		// if (stats.clear) {
			// 		// 	clear()
			// 		// 	return
			// 		// }
			// 		// if (stats.queue.length > 0)
			// 		// 	nodeList.innerHTML = stats.queue
			// 		// 		.map(
			// 		// 			(nick) =>
			// 		// 				`<div class="nick ${
			// 		// 					stats.active == nick && 'active'
			// 		// 				}">${nick}</div>`
			// 		// 		)
			// 		// 		.join('')
			// 		// nodePlaypause.innerHTML = statuses[stats.status ?? 'waiting']
			// 		// document.body.style.background = colors[stats.status ?? 'waiting']
			// 	}
			// }
		</script>
	</body>
</html>

<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>SongDash Debug</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Courier New', monospace;
			background: #1a1a1a;
			color: #e0e0e0;
			padding: 10px;
			font-size: 12px;
		}

		h1 {
			font-size: 16px;
			margin-bottom: 10px;
			color: #00ff00;
			border-bottom: 1px solid #333;
			padding-bottom: 5px;
		}

		h2 {
			font-size: 14px;
			margin: 15px 0 5px 0;
			color: #00aaff;
		}

		.section {
			margin-bottom: 15px;
			border: 1px solid #333;
			padding: 10px;
			background: #0a0a0a;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin: 5px 0;
		}

		th,
		td {
			text-align: left;
			padding: 4px 8px;
			border: 1px solid #333;
		}

		th {
			background: #222;
			color: #ffaa00;
			font-weight: bold;
		}

		td {
			background: #111;
		}

		.status {
			display: inline-block;
			padding: 2px 6px;
			border-radius: 3px;
			font-weight: bold;
		}

		.status.connected {
			background: #004400;
			color: #00ff00;
		}

		.status.disconnected {
			background: #440000;
			color: #ff0000;
		}

		.status.playing {
			background: #004400;
			color: #00ff00;
		}

		.status.paused {
			background: #444400;
			color: #ffff00;
		}

		.status.waiting {
			background: #444444;
			color: #888888;
		}

		.status.active {
			background: #000044;
			color: #00aaff;
		}

		.type-tv {
			background: #440044;
			color: #ff00ff;
			font-weight: bold;
		}

		.type-host {
			background: #004444;
			color: #00ffff;
			font-weight: bold;
		}

		.type-debug {
			background: #444400;
			color: #ffff00;
			font-weight: bold;
		}

		.timestamp {
			float: right;
			color: #666;
			font-size: 11px;
		}

		.key-value {
			display: grid;
			grid-template-columns: 150px 1fr;
			gap: 5px;
			margin: 3px 0;
		}

		.key {
			color: #888;
		}

		.value {
			color: #e0e0e0;
			word-break: break-all;
		}

		.empty {
			color: #666;
			font-style: italic;
		}

		.json {
			background: #000;
			border: 1px solid #333;
			padding: 5px;
			margin: 5px 0;
			overflow-x: auto;
			font-size: 11px;
		}
	</style>
</head>

<body>
	<h1>SongDash Debug Panel <span class="timestamp" id="timestamp">--</span></h1>

	<div class="section">
		<h2>Music Status</h2>
		<div class="key-value">
			<div class="key">Status:</div>
			<div class="value"><span id="music-status" class="status">--</span></div>
		</div>
		<div class="key-value">
			<div class="key">Platform:</div>
			<div class="value" id="music-platform">--</div>
		</div>
		<div class="key-value">
			<div class="key">Listeners:</div>
			<div class="value" id="music-listeners">--</div>
		</div>
		<div class="key-value">
			<div class="key">Metadata:</div>
			<div class="value">
				<div id="music-metadata-author">--</div>
				<div id="music-metadata-track">--</div>
			</div>
		</div>
	</div>

	<div class="section">
		<h2>Queue (<span id="queue-length">0</span> players)</h2>
		<table id="queue-table">
			<thead>
				<tr>
					<th>Pos</th>
					<th>IP</th>
					<th>Nick</th>
					<th>Status</th>
					<th>Time</th>
				</tr>
			</thead>
			<tbody id="queue-body">
				<tr>
					<td colspan="5" class="empty">No players in queue</td>
				</tr>
			</tbody>
		</table>
	</div>

	<div class="section">
		<h2>Scoreboard (<span id="board-total">0</span> players)</h2>
		<table id="board-table">
			<thead>
				<tr>
					<th>IP</th>
					<th>Nick</th>
					<th>Score</th>
					<th>Connected</th>
				</tr>
			</thead>
			<tbody id="board-body">
				<tr>
					<td colspan="4" class="empty">No scores recorded</td>
				</tr>
			</tbody>
		</table>
	</div>

	<div class="section">
		<h2>Clients (<span id="client-count">0</span> total)</h2>
		<table id="client-table">
			<thead>
				<tr>
					<th>IP</th>
					<th>Type</th>
					<th>Nick</th>
					<th>User-Agent</th>
				</tr>
			</thead>
			<tbody id="client-body">
				<tr>
					<td colspan="4" class="empty">No clients connected</td>
				</tr>
			</tbody>
		</table>
	</div>

	<script src="/socket.js"></script>
	<script>
		const socket = new Socket('debug')

		socket.on('update', data => {
			updateDebug(data)
		})

		function updateDebug(data) {
			// Update timestamp
			document.getElementById('timestamp').textContent = new Date(data.timestamp).toLocaleTimeString()

			// Update Music Status
			const musicStatus = document.getElementById('music-status')
			musicStatus.textContent = data.music.status
			musicStatus.className = 'status ' + data.music.status

			document.getElementById('music-platform').textContent = data.music.platform || '--'
			document.getElementById('music-listeners').textContent = data.music.listenerCount

			if (data.music.metadata && data.music.metadata.author && data.music.metadata.track) {
				const metadataText = `${data.music.metadata.author} - ${data.music.metadata.track}`
				document.getElementById('music-metadata-author').textContent = metadataText
				document.getElementById('music-metadata-track').textContent = ''
			} else {
				document.getElementById('music-metadata-author').textContent = '--'
				document.getElementById('music-metadata-track').textContent = ''
			}

			// Update Queue
			document.getElementById('queue-length').textContent = data.queue.length
			const queueBody = document.getElementById('queue-body')

			if (data.queue.queue.length === 0) {
				queueBody.innerHTML = '<tr><td colspan="5" class="empty">No players in queue</td></tr>'
			} else {
				queueBody.innerHTML = data.queue.queue.map(item => `
					<tr>
						<td>${item.position + 1}</td>
						<td>${item.ip}</td>
						<td>${item.nick || '--'}</td>
						<td>${item.isActive ? '<span class="status active">ACTIVE</span>' : ''}</td>
						<td>${item.time !== null ? item.time.toFixed(4) + 's' : '--'}</td>
					</tr>
				`).join('')
			}

			// Update Scoreboard
			document.getElementById('board-total').textContent = data.board.totalPlayers
			const boardBody = document.getElementById('board-body')

			if (data.board.scores.length === 0) {
				boardBody.innerHTML = '<tr><td colspan="4" class="empty">No scores recorded</td></tr>'
			} else {
				boardBody.innerHTML = data.board.scores.map(item => `
					<tr>
						<td>${item.ip}</td>
						<td>${item.nick}</td>
						<td>${item.score}</td>
						<td><span class="status ${item.connected ? 'connected' : 'disconnected'}">${item.connected ? 'YES' : 'NO'}</span></td>
					</tr>
				`).join('')
			}

			// Update Clients
			document.getElementById('client-count').textContent = data.client.clients.length
			const clientBody = document.getElementById('client-body')

			if (data.client.clients.length === 0) {
				clientBody.innerHTML = '<tr><td colspan="4" class="empty">No clients connected</td></tr>'
			} else {
				// Sort clients: special types (tv, host, debug) first, then players
				const specialTypes = ['tv', 'host', 'debug']
				const sortedClients = [...data.client.clients].sort((a, b) => {
					const aSpecial = specialTypes.includes(a.type)
					const bSpecial = specialTypes.includes(b.type)
					if (aSpecial && !bSpecial) return -1
					if (!aSpecial && bSpecial) return 1
					return 0
				})

				clientBody.innerHTML = sortedClients.map(item => {
					let uaDisplay = '--'
					let uaTitle = '--'
					if (item.userAgent) {
						uaDisplay = `${item.userAgent.browser || 'Unknown'} / ${item.userAgent.os || 'Unknown'} / ${item.userAgent.device}`
						uaTitle = item.userAgent.raw
					}
					const typeClass = specialTypes.includes(item.type) ? `type-${item.type}` : ''
					return `
					<tr>
						<td>${item.ip}</td>
						<td class="${typeClass}">${item.type || '--'}</td>
						<td>${item.nick || '--'}</td>
						<td title="${uaTitle}">${uaDisplay}</td>
					</tr>
					`
				}).join('')
			}
		}
	</script>
</body>

</html>